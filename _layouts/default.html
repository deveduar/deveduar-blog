<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: "en" }}">

{%- include head.html -%}

<body>

  {%- include header.html -%}

  <main class="page-content" aria-label="Content">
    <div class="wrapper">
      {{ content }}
    </div>
  </main>

  </div> <!-- Cierre de .site-content -->
  </div> <!-- Cierre de .site-container -->

  <!-- Module loader script -->
  <script src="{{ '/assets/js/module-loader.js' | relative_url }}"></script>
  
  <!-- Load sidebar modules -->
  <script src="{{ '/assets/js/dynamic-sidebar.js' | relative_url }}"></script>
  

<!-- Script para detectar y cargar archive-filters.js -->
<script>
  // Función para inicializar los módulos de archivo
  function initializeArchiveModules() {
    // Define modules for archive page
    if (typeof window.archiveModules === 'undefined') {
      window.archiveModules = [
        "{{ '/assets/js/modules/filters.js' | relative_url }}",
        "{{ '/assets/js/modules/sorting.js' | relative_url }}",
        "{{ '/assets/js/modules/rendering.js' | relative_url }}",
        "{{ '/assets/js/modules/dropdowns.js' | relative_url }}",
        "{{ '/assets/js/modules/urlManager.js' | relative_url }}",
        "{{ '/assets/js/modules/search.js' | relative_url }}"
      ];
    }
    
    // Function to load archive modules
    if (typeof window.loadArchiveScripts === 'function') {
      window.loadArchiveScripts();
    } else {
      window.loadArchiveScripts = function() {
        window.loadModulesForPage(
          '.archive-page', 
          window.archiveModules,
          "{{ '/assets/js/archive-filters.js' | relative_url }}",
          'initArchiveFilters',
          function() {
            // Callback después de cargar los módulos
            if (typeof Dropdowns !== 'undefined' && Dropdowns.reinitializeAllDropdowns) {
              console.log('Reinicializando dropdowns después de cargar módulos');
              Dropdowns.reinitializeAllDropdowns();
            }
          }
        );
      };
      window.loadArchiveScripts();
    }
  }

  // Track if we've already initialized on this page load
  window.archiveInitialized = false;
  
  // Función para limpiar los filtros cuando se sale de la página de archivo
  function resetArchiveFilters() {
    // Limpiar los parámetros de URL relacionados con filtros
    if (window.history && window.history.replaceState) {
      const url = new URL(window.location.href);
      url.searchParams.delete('category');
      url.searchParams.delete('tag');
      url.searchParams.delete('sort');
      url.searchParams.delete('direction');
      url.searchParams.delete('search');
      window.history.replaceState({}, '', url.toString());
    }
    
    // Reiniciar variables globales de filtros si existen
    if (typeof Filters !== 'undefined') {
      Filters.resetFilters();
    }
    
    if (typeof Search !== 'undefined') {
      Search.setSearchQuery('');
    }
    
    if (typeof Sorting !== 'undefined') {
      Sorting.setSortMethod('date', 'desc');
    }
    
    console.log('Filtros de archivo reiniciados');
  }

// Soporte para Turbo (prioridad)
if (typeof Turbo !== 'undefined' || 'Turbo' in window) {
  // Cuando se carga una nueva página
  document.addEventListener('turbo:load', function() {
    console.log('Turbo load en default.html');
    window.archiveInitialized = false; // Reset on each page load
    
    // Forzar una reinicialización completa
    window.archiveModules = undefined;
    
    // Pequeño retraso para asegurar que el DOM está listo
    setTimeout(function() {
      initializeArchiveModules();
    }, 100);
  });
  
  // Antes de visitar una nueva página, limpiar filtros si estamos saliendo de archive
  document.addEventListener('turbo:before-visit', function() {
    if (document.querySelector('.archive-page')) {
      console.log('Saliendo de la página de archivo, reiniciando filtros');
      resetArchiveFilters();
    }
  });
  
// También reinicializar en turbo:render para asegurar que los eventos funcionan
document.addEventListener('turbo:render', function() {
  // Verificar si estamos en la página de archivo
  if (document.querySelector('.archive-page')) {
    console.log('Turbo render en default.html - página de archivo');
    
    // Pequeño retraso para asegurar que el DOM está listo
    setTimeout(function() {
      if (!window.archiveInitialized) {
        window.archiveInitialized = true;
        console.log('Primera inicialización después de turbo:render');
        
        // Reinicializar los botones de ordenación
        if (typeof window.initArchiveFilters === 'function') {
          window.initArchiveFilters();
        }
        
        // Reinicializar dropdowns explícitamente
        if (typeof Dropdowns !== 'undefined' && Dropdowns.reinitializeAllDropdowns) {
          Dropdowns.reinitializeAllDropdowns();
        }
        
        // Aplicar filtros iniciales y actualizar botones activos
        setTimeout(function() {
          const archiveFilters = document.querySelector('.archive-filter-container');
          if (archiveFilters) {
            // Obtener el estado actual
            if (typeof Sorting !== 'undefined') {
              const { currentSortMethod, currentSortDirection } = Sorting.getCurrentSort();
              const sortButtons = document.querySelectorAll('.sort-button');
              
              // Primero, quitar la clase active de todos los botones
              sortButtons.forEach(btn => {
                btn.classList.remove('active');
              });
              
              // Luego, actualizar solo el botón activo
              if (sortButtons.length > 0) {
                Sorting.updateActiveSortButton(sortButtons, currentSortMethod, currentSortDirection);
              }
            }
            
            // Aplicar filtros
            if (typeof window.applyFilters === 'function') {
              window.applyFilters();
            }
          }
        }, 150);
      }
    }, 200);
  }
});
}
  // Fallback para navegación normal
  else {
    document.addEventListener('DOMContentLoaded', initializeArchiveModules);
    
    // Para navegación normal, usar beforeunload
    window.addEventListener('beforeunload', function() {
      if (document.querySelector('.archive-page')) {
        console.log('Saliendo de la página de archivo, reiniciando filtros');
        resetArchiveFilters();
      }
    });
  }
</script>
  
  {% if site.github %}
  <script src="{{ "/assets/js/github-calendar.js" | relative_url }}"></script>
  {% endif %}
  
  <!-- Script para manejar el scroll de paginación -->
  <!-- <script src="{{ '/assets/js/pagination-scroll.js' | relative_url }}"></script> -->
  
  <!-- Add this before the closing body tag -->
  <script src="{{ '/assets/js/post-preview.js' | relative_url }}"></script>
  
  <!-- Include the post layout script -->
  <script src="{{ '/assets/js/post-layout.js' | relative_url }}"></script>
  
  <!-- TOC script -->
  <script src="{{ '/assets/js/toc.js' | relative_url }}"></script>
  
</body>
</html>